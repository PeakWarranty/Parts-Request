<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CHANGE 1: Update the HTML document title -->
    <title>21-Day Manufactured Home Warranty Checklist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styling for status cards */
        .card-UNCHECKED { border-color: #e5e7eb; background-color: #ffffff; }
        .card-OK { border-color: #6ee7b7; background-color: #f0fdfa; }
        .card-ISSUE { border-color: #fca5a5; background-color: #fef2f2; }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">
    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="4xl font-extrabold text-gray-900">
                <!-- CHANGE 2: Update the visible header text -->
                21-Day Move-In Warranty Checklist
            </h1>
            <p class="text-lg text-gray-600 mt-2">
                For New Manufactured Home Owners
            </p>
        </header>

        <!-- Main Form Container -->
        <div class="bg-white p-6 sm:p-8 rounded-3xl shadow-2xl border border-gray-200">
            <form id="warranty-form" class="space-y-6">
                <!-- Property Information -->
                <div class="bg-blue-50 border border-blue-200 p-4 rounded-xl space-y-3">
                    <h2 class="text-xl font-bold text-blue-700">Property Information (Required)</h2>
                    <input type="text" id="homeownerName" name="homeownerName" placeholder="Occupant Name *" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                    
                    <!-- Occupancy Status Field -->
                    <select id="occupancyStatus" name="occupancyStatus" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="" disabled selected>Occupancy Status *</option>
                        <option value="Owner">Owner</option>
                        <option value="Renter">Renter</option>
                    </select>

                    <select id="community" name="community" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="" disabled selected>Select Community *</option>
                        <option value="Rancho Serenidad">Rancho Serenidad</option>
                        <option value="Villas De Mariposa">Villas De Mariposa</option>
                        <option value="Brazos Pointe">Brazos Pointe</option>
                        <option value="Solena">Solena</option>
                        <option value="Other">Other</option>
                    </select>
                    
                    <div id="otherCommunityDiv" class="hidden">
                         <input type="text" id="otherCommunity" name="otherCommunity" placeholder="Specify Other Community Name *" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div class="space-y-2">
                            <!-- CHANGE 1: Placeholder text updated -->
                            <input type="text" id="lotNumber" name="lotNumber" placeholder="Lot Number or Street Address *" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div class="space-y-2">
                            <input type="text" id="serialNumber" name="serialNumber" placeholder="Home Serial Number" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <!-- REMINDER TEXT -->
                            <p class="text-xs text-gray-500 mt-1 ml-1">This can be found on the Data Sheet located under your kitchen sink.</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <input type="tel" id="contactPhone" name="contactPhone" placeholder="Contact Phone Number" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <input type="email" id="email" name="email" placeholder="Email Address *" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                </div>

                <!-- Checklist Container -->
                <div id="checklist-container" class="space-y-6">
                    <!-- Dynamic sections will be rendered here -->
                </div>

                <div id="issue-summary-box" class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 font-semibold hidden"></div>

                <div class="mt-8 pt-4 border-t">
                     <button type="submit" id="submit-btn" class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 rounded-full text-white font-bold text-lg transition duration-150 ease-in-out shadow-lg">
                        Submit Warranty Request
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Status Message Div (Now outside the form structure) -->
        <div id="status-message" class="mt-6 p-4 rounded-lg text-center hidden"></div>
    </div>

    <script>
        // --- CONFIGURATION DATA ---
        // ðŸš¨ IMPORTANT: These IDs are based on our confirmed working configuration.
        const USER_ID = 'bSgwpRuVeEky48mPe'; 
        const SERVICE_ID = 'service_duw9hhb'; 
        const PRIMARY_TEMPLATE_ID = 'of2vt65'; // Sent to warranty team (was template_dvr6oem)
        const CONFIRMATION_TEMPLATE_ID = '2a7qx72'; // Sent to homeowner

        const CHECKLIST_SECTIONS = [
            // [Section 1]
            {
                title: "Interior: Cosmetic & Structure",
                items: [
                    { item: "Batten Strips/Trim", location: "Throughout", description: "Loose, missing, or misaligned strips." },
                    { item: "Wall/Ceiling Seams", location: "Throughout", description: "Obvious gaps or large cracks in drywall/seams." },
                    { item: "Flooring", location: "Throughout", description: "Squeaks, bubbles, loose tiles, or lifted seams." },
                    { item: "Doors (Interior)", location: "Throughout", description: "Do not latch, stick, rub the frame, or have loose hardware." },
                    { item: "Doors (Exterior)", location: "Front/Back", description: "Seal properly, latch securely, and align correctly." },
                    { item: "Cabinets/Drawers", location: "Kitchen/Baths", description: "Loose hinges, drawers stick, missing hardware, or visible damage." },
                    { item: "Countertops", location: "Kitchen/Baths", description: "Scratches, chips, or loose/lifting seams." },
                    { item: "Vinyl/Laminate", location: "Throughout", description: "Scratches, dents, or tears on finished surfaces." },
                    { item: "Windows", location: "Throughout", description: "Screens installed, open/close smoothly, and lock securely." },
                    { item: "Faucets/Fixtures", location: "Kitchen/Baths", description: "Loose handles or visible leaks at the base/connection." },
                ]
            },
            // [Section 2]
            {
                title: "Plumbing, Electrical, & Appliances",
                items: [
                    { item: "Water Flow/Pressure", location: "All Sinks/Tubs", description: "Test all faucets; check for low pressure or unusual noise." },
                    { item: "Toilets", location: "All Bathrooms", description: "Flush properly, no running or leaks at the base." },
                    { item: "Water Heater", location: "Utility/Exterior", description: "Functioning (providing hot water). Check for leaks near the unit." },
                    { item: "GFCI Outlets", location: "Kitchen/Baths/Exterior", description: "Press TEST button to ensure they trip, then press RESET." },
                    { item: "Switches & Outlets", location: "Throughout", description: "All switches operate their lights/fans; outlets have power." },
                    { item: "Smoke/Carbon Monoxide Alarms", location: "Throughout", description: "Test all alarms (usually a test button on the unit)." },
                    { item: "Appliances", location: "Kitchen", description: "Range, Dishwasher, Microwave, Refrigerator are fully operational." },
                ]
            },
            // [Section 3]
            {
                title: "Exterior & HVAC",
                items: [
                    { item: "Siding & Skirting", location: "Exterior", description: "Missing panels, dents, gaps, or improperly fastened skirting." },
                    { item: "Roof Vents/Shingles", location: "Roof/Exterior", description: "Check for loose shingles, damage, or open vents/seals." },
                    { item: "HVAC (Heat/AC)", location: "Thermostat/Units", description: "Run both Heat and Cooling cycles to ensure proper function." },
                    { item: "Ductwork/Vents", location: "Floor/Ceiling", description: "Vents are securely fastened and air is flowing strongly to all rooms." },
                    { item: "Home Leveling", location: "Foundation", description: "Check for noticeable slopes in floors or difficulty closing doors (structural issue)." },
                    { item: "Tie-Downs/Anchors", location: "Under Home", description: "Visibly check anchors/straps for obvious signs of looseness or damage." },
                ]
            }
        ];

        let checklistState = {};

        // --- DOM Elements ---
        const form = document.getElementById('warranty-form');
        const communitySelect = document.getElementById('community');
        const otherCommunityDiv = document.getElementById('otherCommunityDiv');
        const otherCommunityInput = document.getElementById('otherCommunity');
        const statusDiv = document.getElementById('status-message');
        const submitBtn = document.getElementById('submit-btn');
        const checklistContainer = document.getElementById('checklist-container');
        const formMainContent = document.querySelector('form');
        const issueSummaryBox = document.getElementById('issue-summary-box');

        // --- Utility Functions ---

        /**
         * Generates a unique ID for a checklist item.
         */
        const generateId = (item, location) => 
            `${item.replace(/\s/g, '_')}_${location.replace(/\s/g, '_')}`.toLowerCase();

        /**
         * Gets the current submission date formatted as a string.
         */
        const getSubmissionDate = () => {
            return new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        };

        /**
         * Initializes the checklist state object.
         */
        const initializeChecklistState = () => {
            CHECKLIST_SECTIONS.forEach(section => {
                section.items.forEach(item => {
                    const id = generateId(item.item, item.location);
                    checklistState[id] = {
                        status: 'UNCHECKED',
                        notes: '',
                        item: item.item,
                        location: item.location,
                        description: item.description 
                    };
                });
            });
        };

        /**
         * Updates the summary box above the submit button.
         * @param {number} issueCount 
         * @param {number} emptyNotesCount 
         */
        const updateSummary = (issueCount, emptyNotesCount) => {
            if (issueCount === 0) {
                issueSummaryBox.classList.add('hidden');
            } else {
                issueSummaryBox.classList.remove('hidden');
                issueSummaryBox.classList.remove('bg-red-100', 'text-red-800');
                issueSummaryBox.classList.add('bg-yellow-50', 'text-yellow-800');

                if (emptyNotesCount > 0) {
                    issueSummaryBox.classList.add('bg-red-100', 'text-red-800');
                    issueSummaryBox.innerHTML = `âš ï¸ **ERROR:** ${emptyNotesCount} issue(s) are marked but are missing required descriptions. Please add notes to submit.`;
                    submitBtn.disabled = true;
                } else {
                    issueSummaryBox.innerHTML = `âœ… **${issueCount} issues** identified and described. Ready to submit.`;
                    submitBtn.disabled = false;
                }
            }
        };


        /**
         * Renders the entire checklist into the DOM.
         */
        const renderChecklist = () => {
            let issueCount = 0;
            let emptyNotesCount = 0;
            checklistContainer.innerHTML = ''; 

            CHECKLIST_SECTIONS.forEach((section) => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'space-y-3 p-4 bg-white rounded-xl shadow-md border border-gray-100';
                sectionDiv.innerHTML = `<h2 class="text-2xl font-extrabold text-gray-800 border-b pb-2 mb-4">${section.title}</h2>`;

                section.items.forEach((item) => {
                    const id = generateId(item.item, item.location);
                    const state = checklistState[id];
                    const isIssue = state.status === 'ISSUE';

                    if (isIssue) {
                        issueCount++;
                        if (state.notes.trim() === '') {
                            emptyNotesCount++;
                        }
                    }

                    const cardClasses = `p-4 rounded-lg border-2 transition-colors duration-200 card-${state.status}`;

                    const itemHtml = `
                        <div id="item-${id}" class="${cardClasses}">
                            <div class="flex flex-col sm:flex-row justify-between items-start space-y-2 sm:space-y-0 sm:space-x-4 mb-2">
                                <div class="flex-1">
                                    <p class="font-semibold text-lg text-gray-900">${item.item}</p>
                                    <p class="text-sm text-gray-500">
                                        <span class="font-medium text-gray-600">Location:</span> ${item.location}
                                        <span class="mx-2 text-gray-300 hidden sm:inline">|</span>
                                        <span class="font-medium text-gray-600">Check:</span> ${item.description}
                                    </p>
                                </div>
                                <div class="flex space-x-2 flex-shrink-0 pt-1">
                                    <button data-id="${id}" data-status="OK" class="status-btn px-3 py-1 text-sm font-medium rounded-full transition ${state.status === 'OK' ? 'bg-green-600 text-white shadow-md' : 'bg-green-100 text-green-700 hover:bg-green-200'}">
                                        <span class="hidden sm:inline">Mark </span>OK
                                    </button>
                                    <button data-id="${id}" data-status="ISSUE" class="status-btn px-3 py-1 text-sm font-medium rounded-full transition ${state.status === 'ISSUE' ? 'bg-red-600 text-white shadow-md' : 'bg-red-100 text-red-700 hover:bg-red-200'}">
                                        <span class="hidden sm:inline">Mark </span>Issue
                                    </button>
                                    <button data-id="${id}" data-status="UNCHECKED" class="status-btn px-3 py-1 text-sm font-medium rounded-full transition ${state.status === 'UNCHECKED' ? 'bg-gray-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
                                        Clear
                                    </button>
                                </div>
                            </div>
                            
                            ${isIssue ? `
                                <textarea
                                    data-id="${id}"
                                    class="notes-input mt-2 w-full p-3 border border-red-300 rounded-lg focus:ring-red-500 focus:border-red-500 text-gray-800"
                                    placeholder="REQUIRED: Describe the issue in detail for repair submission (e.g., 'Squeak in hallway floor near linen closet')."
                                    rows="2"
                                >${state.notes}</textarea>
                            ` : ''}
                        </div>
                    `;
                    sectionDiv.insertAdjacentHTML('beforeend', itemHtml);
                });
                checklistContainer.appendChild(sectionDiv);
            });

            updateSummary(issueCount, emptyNotesCount);

            // Re-attach event listeners after rendering
            document.querySelectorAll('.status-btn').forEach(button => {
                button.addEventListener('click', handleStatusChange);
            });

            document.querySelectorAll('.notes-input').forEach(input => {
                input.addEventListener('input', handleNotesChange);
            });
        };

        /**
         * Updates the status of a checklist item and re-renders if necessary.
         */
        const handleStatusChange = (e) => {
            const id = e.target.closest('.status-btn').dataset.id;
            const newStatus = e.target.closest('.status-btn').dataset.status;

            if (checklistState[id].status !== newStatus) {
                checklistState[id].status = newStatus;
                if (newStatus !== 'ISSUE') {
                    checklistState[id].notes = '';
                }
                renderChecklist();
            }
        };

        /**
         * Updates the notes for a checklist item.
         */
        const handleNotesChange = (e) => {
            const id = e.target.dataset.id;
            checklistState[id].notes = e.target.value;
            renderChecklist(); // Re-render to update the summary box immediately
        };
        
        /**
         * Toggles the visibility and required status of the 'Other Community' input.
         */
        const handleCommunityChange = () => {
            if (communitySelect.value === 'Other') {
                otherCommunityDiv.classList.remove('hidden');
                otherCommunityInput.required = true;
            } else {
                otherCommunityDiv.classList.add('hidden');
                otherCommunityInput.required = false;
                otherCommunityInput.value = '';
            }
        };

        /**
         * Validates the required homeowner info fields.
         */
        const validateHomeownerInfo = (formData) => {
            if (!formData.homeownerName.trim()) return "Occupant Name is required.";
            if (!formData.email.trim()) return "Email Address is required.";
            // Validation check using the updated message
            if (!formData.lotNumber.trim()) return "Lot Number or Street Address is required.";
            if (!formData.community.trim()) return "Community selection is required.";
            if (formData.community === 'Other' && !formData.otherCommunity.trim()) return "Please specify the Other Community Name.";
            return null;
        };

        /**
         * Compiles all submission data and the formatted report.
         */
        const compileSubmissionData = () => {
            const formData = {
                homeownerName: form.elements.homeownerName.value.trim(),
                occupancyStatus: form.elements.occupancyStatus.value, // Added for new field
                community: form.elements.community.value,
                otherCommunity: form.elements.otherCommunity ? form.elements.otherCommunity.value.trim() : '',
                lotNumber: form.elements.lotNumber.value.trim(),
                serialNumber: form.elements.serialNumber.value.trim(),
                contactPhone: form.elements.contactPhone.value.trim(),
                email: form.elements.email.value.trim(),
            };
            
            const finalCommunity = formData.community === 'Other' ? formData.otherCommunity : formData.community;
            const submissionDate = getSubmissionDate();
            
            const issuesList = Object.values(checklistState).filter(item => 
                item.status === 'ISSUE' && item.notes.trim() !== ''
            );

            const issuesReport = issuesList.map((item, index) => {
                const locationDetail = item.location ? ` (Location: ${item.location})` : '';
                return `**${index + 1}. ${item.item}${locationDetail}**\nDescription: ${item.notes}\n`;
            }).join('\n');

            // Update label in the final report text
            const finalReportText = `*** Property Information ***\n` +
                                   `Occupant Name: ${formData.homeownerName}\n` + 
                                   `Occupancy Status: ${formData.occupancyStatus}\n` + 
                                   `Community: ${finalCommunity}\n` +
                                   `Lot/Street Address: ${formData.lotNumber}\n` + // Updated label
                                   `Serial #: ${formData.serialNumber}\n` +
                                   `Phone: ${formData.contactPhone}\n` +
                                   `Email: ${formData.email}\n` +
                                   `Date: ${submissionDate}\n\n` +
                                   `*** Reported Issues (${issuesList.length} Total) ***\n` +
                                   (issuesReport || 'No actionable issues with description were reported.');

            return {
                formData,
                issuesList,
                submissionDate,
                finalCommunity,
                finalReportText,
                // EmailJS requires specific keys that match the templates we previously verified
                emailParams: {
                    'homeownerName': formData.homeownerName,
                    'occupancyStatus': formData.occupancyStatus, // Added for EmailJS
                    'community': finalCommunity,
                    'lotNumber': formData.lotNumber, // Note: Variable name remains 'lotNumber' but contains address/lot data
                    'serialNumber': formData.serialNumber,
                    'contactPhone': formData.contactPhone,
                    'email': formData.email,
                    'SubmissionDate': submissionDate,
                    'toEmail': 'warranty@peakmhc.com', // Recipient for the primary template
                    'totalissues': issuesList.length,
                    'issuesReport': finalReportText, // The compiled report body
                }
            };
        };


        /**
         * Handles the final submission of data via EmailJS (using the working Promise chain).
         */
        const handleSubmission = (event) => {
            event.preventDefault();
            
            const { formData, emailParams } = compileSubmissionData();
            
            // 1. Final Client-Side Validation
            const infoError = validateHomeownerInfo(formData);
            if (infoError) {
                statusDiv.classList.remove('hidden');
                statusDiv.classList.add('bg-red-100', 'text-red-800');
                statusDiv.innerHTML = `<strong>Error!</strong> ${infoError}`;
                return;
            }
            if (submitBtn.disabled) {
                // This check relies on updateSummary running, which updates submitBtn.disabled
                statusDiv.classList.remove('hidden');
                statusDiv.classList.add('bg-red-100', 'text-red-800');
                statusDiv.innerHTML = `<strong>Error!</strong> Please provide descriptions for all marked issues.`;
                return;
            }
            
            // 2. Set UI to Sending (using the working app's proven flow)
            formMainContent.style.display = 'none';
            statusDiv.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
            statusDiv.classList.add('bg-blue-100', 'text-blue-800');
            statusDiv.innerHTML = 'Sending request... Please wait.';
            submitBtn.disabled = true;

            // 3. Initialize if not already done (defensive check)
            if (!window.emailjs || !window.emailjs.send) {
                 statusDiv.innerHTML = '<strong>Error!</strong> EmailJS library is not fully loaded. Please refresh the page.';
                 return;
            }
            
            // 4. Two-Step Submission via Promise Chain (The reliable method)
            
            // Step 1: Send the Primary Report to the warranty team
            window.emailjs.send(SERVICE_ID, PRIMARY_TEMPLATE_ID, emailParams)
                .then(function() {
                    // Step 2: Primary sent. Send Confirmation email to the homeowner.
                    return window.emailjs.send(SERVICE_ID, CONFIRMATION_TEMPLATE_ID, emailParams);
                })
                .then(function() {
                    // Success: Both emails sent. Show success message.
                    statusDiv.classList.remove('bg-blue-100', 'text-blue-800');
                    statusDiv.classList.add('bg-green-100', 'text-green-800');
                    statusDiv.innerHTML = '<strong>Success!</strong> Your request has been sent, and a confirmation email has been sent to your inbox. <br><br> <button id="continue-btn" class="py-2 px-4 mt-2 bg-blue-600 hover:bg-blue-700 rounded-full text-white font-bold transition duration-150 ease-in-out">Submit Another Request</button>';
                    
                    document.getElementById('continue-btn').addEventListener('click', resetForm);
                }, function(error) {
                    // Failure: Could be Primary or Confirmation email failure.
                    let errorMessage = 'There was an error sending your request.';
                    if (error && error.text) {
                         errorMessage = `Error: ${error.text}`;
                    }
                    
                    statusDiv.classList.remove('bg-blue-100', 'text-blue-800');
                    statusDiv.classList.add('bg-red-100', 'text-red-800');
                    statusDiv.innerHTML = `<strong>Failed!</strong> ${errorMessage}`;
                    console.error('EmailJS Error:', error);
                    
                    // Show form content again on failure
                    formMainContent.style.display = 'block';
                })
                .finally(() => {
                    submitBtn.disabled = false;
                });
        };
        
        /**
         * Resets the form after a successful submission.
         */
        const resetForm = () => {
             form.reset();
             initializeChecklistState(); // Reset checklist data
             renderChecklist(); // Rerender to show clean list
             statusDiv.classList.add('hidden');
             formMainContent.style.display = 'block';
        };

        /**
         * Initializes the app on window load.
         */
        const initApp = () => {
             if (window.emailjs) {
                 window.emailjs.init(USER_ID);
             }

             initializeChecklistState();
             renderChecklist();
             
             // Event Listeners
             document.getElementById('community').addEventListener('change', handleCommunityChange);
             form.addEventListener('submit', handleSubmission);
        }

        // --- Initialization ---
        window.onload = initApp;
    </script>
</body>
</html>
